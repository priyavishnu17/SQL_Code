DECLARE @StartDate DATE = '2024-06-01';

SELECT
    SourceTableName,
    YEAR(EntryDate)  AS [Year],
    DATENAME(MONTH, EntryDate) AS [Month],
    MONTH(EntryDate) AS MonthNumber,
    SUM(TotalDataTransfered) AS TotalDataTransferred
FROM [DBADB].[dbo].[TBL_RETENTION_LOGS]
WHERE EntryDate >= @StartDate
  AND EntryDate <  GETDATE()
GROUP BY
    SourceTableName,
    YEAR(EntryDate),
    MONTH(EntryDate),
    DATENAME(MONTH, EntryDate)
ORDER BY
    SourceTableName,
    [Year],
    MonthNumber;


WITH MonthlySize AS
(
    SELECT
        Instance_Name,
        Database_Names,
        YEAR([Dates])  AS [Year],
        MONTH([Dates]) AS MonthNumber,
        DATENAME(MONTH, [Dates]) AS [Month],
        MAX([Size MB]) AS SizeMB
    FROM [DBADB].[dbo].[DB_Meta]
    WHERE [Dates] >= '2024-06-01'
      AND [Dates] <  GETDATE()
    GROUP BY
        Instance_Name,
        Database_Names,
        YEAR([Dates]),
        MONTH([Dates]),
        DATENAME(MONTH, [Dates])
)
SELECT
    Instance_Name,
    Database_Names,
    [Year],
    [Month],
    MonthNumber,
    SizeMB AS CurrentSize_MB,
    LAG(SizeMB) OVER (
        PARTITION BY Instance_Name, Database_Names
        ORDER BY [Year], MonthNumber
    ) AS PreviousMonthSize_MB,
    (SizeMB -
     LAG(SizeMB) OVER (
        PARTITION BY Instance_Name, Database_Names
        ORDER BY [Year], MonthNumber
     )) AS Growth_MB,
    ROUND(
        (
            (SizeMB -
             LAG(SizeMB) OVER (
                PARTITION BY Instance_Name, Database_Names
                ORDER BY [Year], MonthNumber
             )) * 100.0
        ) /
        NULLIF(
            LAG(SizeMB) OVER (
                PARTITION BY Instance_Name, Database_Names
                ORDER BY [Year], MonthNumber
            ), 0
        ), 2
    ) AS Growth_Percentage
FROM MonthlySize
ORDER BY
    Instance_Name,
    Database_Names,
    [Year],
    MonthNumber;


WITH MonthlySize AS
(
    SELECT
        Instance_Name,
        Database_Names,
        YEAR([Dates])  AS [Year],
        MONTH([Dates]) AS MonthNumber,
        DATENAME(MONTH, [Dates]) AS [Month],
        MAX([Size MB]) AS SizeMB
    FROM [DBADB].[dbo].[DB_Meta]
    WHERE [Dates] >= '2024-06-01'   -- FROM JUNE
      AND [Dates] <  GETDATE()
    GROUP BY
        Instance_Name,
        Database_Names,
        YEAR([Dates]),
        MONTH([Dates]),
        DATENAME(MONTH, [Dates])
)
SELECT
    Instance_Name,
    Database_Names,
    [Year],
    [Month],
    MonthNumber,
    SizeMB AS CurrentSize_MB,
    ROUND(SizeMB / 1024.0, 2) AS CurrentSize_GB,
    LAG(SizeMB) OVER (
        PARTITION BY Instance_Name, Database_Names
        ORDER BY [Year], MonthNumber
    ) AS PreviousMonthSize_MB,
    ROUND(LAG(SizeMB) OVER (
        PARTITION BY Instance_Name, Database_Names
        ORDER BY [Year], MonthNumber
    ) / 1024.0, 2) AS PreviousMonthSize_GB,
    (SizeMB -
     LAG(SizeMB) OVER (
        PARTITION BY Instance_Name, Database_Names
        ORDER BY [Year], MonthNumber
     )) AS Growth_MB,
    ROUND(
        (SizeMB -
         LAG(SizeMB) OVER (
            PARTITION BY Instance_Name, Database_Names
            ORDER BY [Year], MonthNumber
         )) / 1024.0, 2
    ) AS Growth_GB,
    ROUND(
        (
            (SizeMB -
             LAG(SizeMB) OVER (
                PARTITION BY Instance_Name, Database_Names
                ORDER BY [Year], MonthNumber
             )) * 100.0
        ) /
        NULLIF(
            LAG(SizeMB) OVER (
                PARTITION BY Instance_Name, Database_Names
                ORDER BY [Year], MonthNumber
            ), 0
        ), 2
    ) AS Growth_Percentage
FROM MonthlySize
ORDER BY
    Instance_Name,
    Database_Names,
    [Year],
    MonthNumber;


SELECT
    YEAR(CaptureDate) AS [Year],
    DATENAME(MONTH, CaptureDate) AS [Month],
    AVG([Value]) AS AvgTransactionsPerSec,
    MAX([Value]) AS MaxTransactionsPerSec,
    MIN([Value]) AS MinTransactionsPerSec
FROM [DBADB].[dbo].[PerfMonData]
WHERE CaptureDate > '2025-06-01'
  AND Counter = 'SQLServer:Databases: Transactions/sec:MARSPROD'
GROUP BY YEAR(CaptureDate), MONTH(CaptureDate), DATENAME(MONTH, CaptureDate)
ORDER BY YEAR(CaptureDate), MONTH(CaptureDate);

